---
title: "NHANES Allostatic (over)Load Dataset Construction"
subtitle: "CHORDS Lab – Washington State University"
author: 
  - "Jason Cross"
  - "Mariah Bergquist"
  - "Maya Dietrich"
  - "William Ripplinger"
  - "Owen Williams"
  - "Shawna Beese"
date: "Last updated: 2026-02-21"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

---

## Overview

This R Markdown script walks through the creation of a dataset for allostatic (over)load research using data from the [National Health and Nutrition Examination Survey (NHANES).](https://www.cdc.gov/nchs/nhanes/).

⚠️ As noted in the [`NHANES_access_guide.md`](https://github.com/CHORDSLab/Allostatic-over-Load-Repository/blob/main/NHANES/NHANES_access_guide.md), this script uses the `nhanesA` package to programmatically access NHANES data, rather than relying on manual downloads.


---

## Setup & Libraries

First, make sure you've installed the `tidyverse`, `nhanesA` and `Hmisc` packages. If you haven’t installed them yet, run the following commands in your console:

```{r, eval=FALSE}
# install.packages("nhanesA")
# install.packages("tidyverse")
# install.packages("Hmisc")
```

Once you've installed `tidyverse` and `nhanesA` successfully, load both packages.

```{r load-libraries, echo=TRUE}
# Load required libraries
library(tidyverse)
library(nhanesA)
library(Hmisc)
```


---

## Part 1 – Download, Clean, and Combine NHANES Survey Cycles (1999–2023)

In this section, we’ll load NHANES survey cycles from 1999–2023, clean key variables, and combine them into a unified dataset.

---

### Load 2021-2023 NHANES Data

```{r}

#####################
# Load 2021-2023 NHANES Data
#####################

# 1. Download and clean demographics (+ include weights + design vars)
nhanes_2123 <- nhanes("DEMO_L") %>%
  transmute(
    SEQN,
    survey_years = "2021-2023",
    gender = RIAGENDR,
    age = RIDAGEYR,
    race = RIDRETH1,
    race_w_nh_asian = RIDRETH3,

    # weights (renamed for cross-cycle harmonization)
    WTINT = WTINT2YR, # Full sample 2 year interview weight
    WTMEC = WTMEC2YR, # Full sample 2 year MEC exam weight

    # design variables (needed for correct variance estimation)
    SDMVSTRA = SDMVSTRA, # Masked variance unit pseudo-stratum variable for variance estimation
    SDMVPSU  = SDMVPSU # Masked variance unit pseudo-PSU variable for variance estimation
  )

# 2. Download and clean lab data (+ include phlebotomy weight)
lab_2123 <- list(
  nhanes("GHB_L"),
  nhanes("HDL_L"),
  nhanes("HSCRP_L")
) %>%
  reduce(left_join, by = "SEQN") %>%
  transmute(
    SEQN,
    CRP = LBXHSCRP,
    A1C = LBXGH,
    HDL = LBDHDD,

    WTPH = WTPH2YR # Phlebotomy 2 Year Weight
  )

# 3. Download and clean exam data
exam_2123 <- nhanes("BPXO_L") %>%
  left_join(nhanes("BMX_L"), by = "SEQN") %>%
  transmute(
    SEQN,
    PULSE = BPXOPLS3,
    waist = BMXWAIST,
    height = BMXHT
  )

# 4. Merge all datasets
nhanes_2123 <- nhanes_2123 %>%
  left_join(lab_2123, by = "SEQN") %>%
  left_join(exam_2123, by = "SEQN") %>%
  select(
    survey_years, SEQN,
    gender, age, race, race_w_nh_asian,
    CRP, A1C, HDL,
    PULSE, waist, height,
    WTINT, WTMEC, WTPH,
    SDMVSTRA, SDMVPSU
  )

glimpse(nhanes_2123)

```

---

### Load 2017-2020 (Pre-Pandemic) NHANES Data

> ⚠️ **Note:** The NHANES program suspended data collection in March 2020 due to the COVID-19 pandemic. Because the 2019–2020 cycle was not fully completed or nationally representative on its own, data from this period were combined with 2017–2018 to create a single 2017–March 2020 pre-pandemic dataset. For details and analytic guidance, see the [NHANES 2017–March 2020 Pre-pandemic overview](https://wwwn.cdc.gov/nchs/nhanes/continuousnhanes/OverviewBrief.aspx?Cycle=2017-2020).


```{r}

#####################
# Load 2017-2020 (Pre-Pandemic) NHANES Data
#####################

# 1. Download and clean demographics (+ include weights + design vars)
nhanes_1720PP <- nhanes("P_DEMO") %>%
  transmute(
    SEQN,
    survey_years = "2017-2020 (Pre-Pandemic)",
    gender = RIAGENDR,
    age = RIDAGEYR,
    race = RIDRETH1,
    race_w_nh_asian = RIDRETH3,

    # weights (renamed for cross-cycle harmonization)
    WTINT = WTINTPRP, # Full sample interview weight
    WTMEC = WTMECPRP, # Full sample MEC exam weight

    # design variables (needed for correct variance estimation)
    SDMVSTRA = SDMVSTRA, # Masked variance unit pseudo-stratum variable for variance estimation
    SDMVPSU  = SDMVPSU # Masked variance unit pseudo-PSU variable for variance estimation
  )

# 2. Download and clean lab data
# Note: Unlike the 2021–2023 cycle, the pre-pandemic 2017–Mar 2020 files
# do not include a separate phlebotomy weight. Analyses involving these
# lab variables should use the MEC exam weight (WTMEC).
lab_1720PP <- list(
  nhanes("P_GHB"),
  nhanes("P_HDL"),
  nhanes("P_HSCRP")
) %>%
  reduce(left_join, by = "SEQN") %>%
  transmute(
    SEQN,
    CRP = LBXHSCRP,
    A1C = LBXGH,
    HDL = LBDHDD,
    
    WTPH = NA_real_ # Placeholder for harmonization (no phlebotomy weight for this cycle)
  )

# 3. Download and clean exam data
exam_1720PP <- nhanes("P_BPXO") %>%
  left_join(nhanes("P_BMX"), by = "SEQN") %>%
  transmute(
    SEQN,
    PULSE = BPXOPLS3,
    waist = BMXWAIST,
    height = BMXHT
  )

# 4. Merge all datasets
nhanes_1720PP <- nhanes_1720PP %>%
  left_join(lab_1720PP, by = "SEQN") %>%
  left_join(exam_1720PP, by = "SEQN") %>%
  select(
    survey_years, SEQN,
    gender, age, race, race_w_nh_asian,
    CRP, A1C, HDL,
    PULSE, waist, height,
    WTINT, WTMEC, WTPH, 
    SDMVSTRA, SDMVPSU
  )

glimpse(nhanes_1720PP)

```

---

### Load 2017-2018 NHANES Data

```{r}

#####################
# Load 2017-2018 NHANES Data
#####################

# 1. Download and clean demographics (+ include weights + design vars)
nhanes_1718 <- nhanes("DEMO_J") %>%
  transmute(
    SEQN,
    survey_years = "2017-2018",
    gender = RIAGENDR,
    age = RIDAGEYR,
    race = RIDRETH1,
    race_w_nh_asian = RIDRETH3,

    # weights (renamed for cross-cycle harmonization)
    WTINT = WTINT2YR, # Full sample 2 year interview weight
    WTMEC = WTMEC2YR, # Full sample 2 year MEC exam weight

    # design variables (needed for correct variance estimation)
    SDMVSTRA = SDMVSTRA, # Masked variance unit pseudo-stratum variable for variance estimation
    SDMVPSU  = SDMVPSU # Masked variance unit pseudo-PSU variable for variance estimation
  )

# 2. Download and clean lab data
# Note: No separate phlebotomy weight is provided for 2017–2018;
# lab variables should use the MEC exam weight (WTMEC).
lab_1718 <- list(
  nhanes("GHB_J"),
  nhanes("HDL_J"),
  nhanes("HSCRP_J")
) %>%
  reduce(left_join, by = "SEQN") %>%
  transmute(
    SEQN,
    CRP = LBXHSCRP,
    A1C = LBXGH,
    HDL = LBDHDD,

    WTPH = NA_real_ # Placeholder for harmonization (no phlebotomy weight for this cycle)
  )

# 3. Download and clean exam data
exam_1718 <- nhanes("BPX_J") %>%
  left_join(nhanes("BMX_J"), by = "SEQN") %>%
  transmute(
    SEQN,
    PULSE = BPXPLS,
    waist = BMXWAIST,
    height = BMXHT
  )

# 4. Merge all datasets
nhanes_1718 <- nhanes_1718 %>%
  left_join(lab_1718, by = "SEQN") %>%
  left_join(exam_1718, by = "SEQN") %>%
  select(
    survey_years, SEQN,
    gender, age, race, race_w_nh_asian,
    CRP, A1C, HDL,
    PULSE, waist, height,
    WTINT, WTMEC, WTPH,
    SDMVSTRA, SDMVPSU
  )

glimpse(nhanes_1718)

```

---

### Load 2015-2016 NHANES Data

```{r}

#####################
# Load 2015-2016 NHANES Data
#####################

# 1. Download and clean demographics (+ include weights + design vars)
nhanes_1516 <- nhanes("DEMO_I") %>%
  transmute(
    SEQN,
    survey_years = "2015-2016",
    gender = RIAGENDR,
    age = RIDAGEYR,
    race = RIDRETH1,
    race_w_nh_asian = RIDRETH3,

    # weights (renamed for cross-cycle harmonization)
    WTINT = WTINT2YR, # Full sample 2 year interview weight
    WTMEC = WTMEC2YR, # Full sample 2 year MEC exam weight

    # design variables (needed for correct variance estimation)
    SDMVSTRA = SDMVSTRA, # Masked variance unit pseudo-stratum variable for variance estimation
    SDMVPSU  = SDMVPSU # Masked variance unit pseudo-PSU variable for variance estimation
  )

# 2. Download and clean lab data
# Note: No separate phlebotomy weight is provided for 2015–2016;
# lab variables should use the MEC exam weight (WTMEC).
lab_1516 <- list(
  nhanes("GHB_I"),
  nhanes("HDL_I"),
  nhanes("HSCRP_I")
) %>%
  reduce(left_join, by = "SEQN") %>%
  transmute(
    SEQN,
    CRP = LBXHSCRP,
    A1C = LBXGH,
    HDL = LBDHDD,

    WTPH = NA_real_ # Placeholder for harmonization (no phlebotomy weight for this cycle)
  )

# 3. Download and clean exam data
exam_1516 <- nhanes("BPX_I") %>%
  left_join(nhanes("BMX_I"), by = "SEQN") %>%
  transmute(
    SEQN,
    PULSE = BPXPLS,
    waist = BMXWAIST,
    height = BMXHT
  )

# 4. Merge all datasets
nhanes_1516 <- nhanes_1516 %>%
  left_join(lab_1516, by = "SEQN") %>%
  left_join(exam_1516, by = "SEQN") %>%
  select(
    survey_years, SEQN,
    gender, age, race, race_w_nh_asian,
    CRP, A1C, HDL,
    PULSE, waist, height,
    WTINT, WTMEC, WTPH,
    SDMVSTRA, SDMVPSU
  )

glimpse(nhanes_1516)

```

---

### Load 2013-2014 NHANES Data

> ⚠️ **Note:** C-reactive protein (CRP) data are *not* available for the 2013–2014 NHANES cycle. This survey wave did not include CRP in its lab measurements.


```{r}

#####################
# Load 2013-2014 NHANES Data
#####################

# 1. Download and clean demographics (+ include weights + design vars)
nhanes_1314 <- nhanes("DEMO_H") %>%
  transmute(
    SEQN,
    survey_years = "2013-2014",
    gender = RIAGENDR,
    age = RIDAGEYR,
    race = RIDRETH1,
    race_w_nh_asian = RIDRETH3,

    # weights (renamed for cross-cycle harmonization)
    WTINT = WTINT2YR, # Full sample 2 year interview weight
    WTMEC = WTMEC2YR, # Full sample 2 year MEC exam weight

    # design variables (needed for correct variance estimation)
    SDMVSTRA = SDMVSTRA, # Masked variance unit pseudo-stratum variable for variance estimation
    SDMVPSU  = SDMVPSU # Masked variance unit pseudo-PSU variable for variance estimation
  )

# 2. Download and clean lab data
# Note: C-reactive protein (CRP) data are not available for the 2013–2014 cycle.
# Also note: No separate phlebotomy weight is provided for 2013–2014;
# lab variables should use the MEC exam weight (WTMEC).
lab_1314 <- list(
  nhanes("GHB_H"),
  nhanes("HDL_H")
) %>%
  reduce(left_join, by = "SEQN") %>%
  transmute(
    SEQN,
    CRP = NA_real_, # Placeholder for harmonization (CRP not measured in 2013–2014)
    A1C = LBXGH,
    HDL = LBDHDD,

    WTPH = NA_real_ # Placeholder for harmonization (no phlebotomy weight for this cycle)
  )

# 3. Download and clean exam data
exam_1314 <- nhanes("BPX_H") %>%
  left_join(nhanes("BMX_H"), by = "SEQN") %>%
  transmute(
    SEQN,
    PULSE = BPXPLS,
    waist = BMXWAIST,
    height = BMXHT
  )

# 4. Merge all datasets
nhanes_1314 <- nhanes_1314 %>%
  left_join(lab_1314, by = "SEQN") %>%
  left_join(exam_1314, by = "SEQN") %>%
  select(
    survey_years, SEQN,
    gender, age, race, race_w_nh_asian,
    CRP, A1C, HDL,
    PULSE, waist, height,
    WTINT, WTMEC, WTPH,
    SDMVSTRA, SDMVPSU
  )

glimpse(nhanes_1314)

```


---

### Load 2011-2012 NHANES Data

> ⚠️ **Note:** C-reactive protein (CRP) data are *not* available for the 2011–2012 NHANES cycle. This survey wave did not include CRP in its lab measurements.

```{r}

#####################
# Load 2011-2012 NHANES Data
#####################

# 1. Download and clean demographics (+ include weights + design vars)
nhanes_1112 <- nhanes("DEMO_G") %>%
  transmute(
    SEQN,
    survey_years = "2011-2012",
    gender = RIAGENDR,
    age = RIDAGEYR,
    race = RIDRETH1,
    race_w_nh_asian = RIDRETH3,

    # weights (renamed for cross-cycle harmonization)
    WTINT = WTINT2YR, # Full sample 2 year interview weight
    WTMEC = WTMEC2YR, # Full sample 2 year MEC exam weight

    # design variables (needed for correct variance estimation)
    SDMVSTRA = SDMVSTRA, # Masked variance unit pseudo-stratum variable for variance estimation
    SDMVPSU  = SDMVPSU # Masked variance unit pseudo-PSU variable for variance estimation
  )

# 2. Download and clean lab data
# Note: C-reactive protein (CRP) data are not available for the 2011–2012 cycle.
# Also note: No separate phlebotomy weight is provided for 2011–2012;
# lab variables should use the MEC exam weight (WTMEC).
lab_1112 <- list(
  nhanes("GHB_G"),
  nhanes("HDL_G")
) %>%
  reduce(left_join, by = "SEQN") %>%
  transmute(
    SEQN,
    CRP = NA_real_, # Placeholder for harmonization (CRP not measured in 2011–2012)
    A1C = LBXGH,
    HDL = LBDHDD,

    WTPH = NA_real_ # Placeholder for harmonization (no phlebotomy weight for this cycle)
  )

# 3. Download and clean exam data
exam_1112 <- nhanes("BPX_G") %>%
  left_join(nhanes("BMX_G"), by = "SEQN") %>%
  transmute(
    SEQN,
    PULSE = BPXPLS,
    waist = BMXWAIST,
    height = BMXHT
  )

# 4. Merge all datasets
nhanes_1112 <- nhanes_1112 %>%
  left_join(lab_1112, by = "SEQN") %>%
  left_join(exam_1112, by = "SEQN") %>%
  select(
    survey_years, SEQN,
    gender, age, race, race_w_nh_asian,
    CRP, A1C, HDL,
    PULSE, waist, height,
    WTINT, WTMEC, WTPH,
    SDMVSTRA, SDMVPSU
  )

glimpse(nhanes_1112)

```

---

### Load 2009-2010 NHANES Data

> ⚠️ **Note:** The more detailed race/ethnicity variable `RIDRETH3` (which includes a separate category for Non-Hispanic Asian participants) is *not* available for NHANES survey cycles from 1999 to 2009. During these years, only the original `RIDRETH1` variable was collected.

```{r}

#####################
# Load 2009-2010 NHANES Data
#####################

# 1. Download and clean demographics (+ include weights + design vars)
nhanes_0910 <- nhanes("DEMO_F") %>%
  transmute(
    SEQN,
    survey_years = "2009-2010",
    gender = RIAGENDR,
    age = RIDAGEYR,
    race = RIDRETH1, 
    race_w_nh_asian = NA, # Placeholder for harmonization (RIDRETH3 not measured in this cycle)

    # weights (renamed for cross-cycle harmonization)
    WTINT = WTINT2YR, # Full sample 2 year interview weight
    WTMEC = WTMEC2YR, # Full sample 2 year MEC exam weight

    # design variables (needed for correct variance estimation)
    SDMVSTRA = SDMVSTRA, # Masked variance unit pseudo-stratum variable for variance estimation
    SDMVPSU  = SDMVPSU # Masked variance unit pseudo-PSU variable for variance estimation
  )

# 2. Download and clean lab data
# Note: No separate phlebotomy weight is provided for 2009–2010;
# lab variables should use the MEC exam weight (WTMEC).
lab_0910 <- list(
  nhanes("GHB_F"),
  nhanes("HDL_F"),
  nhanes("CRP_F")
) %>%
  reduce(left_join, by = "SEQN") %>%
  transmute(
    SEQN,
    CRP = LBXCRP,
    A1C = LBXGH,
    HDL = LBDHDD,

    WTPH = NA_real_ # Placeholder for harmonization (no phlebotomy weight for this cycle)
  )

# 3. Download and clean exam data
exam_0910 <- nhanes("BPX_F") %>%
  left_join(nhanes("BMX_F"), by = "SEQN") %>%
  transmute(
    SEQN,
    PULSE = BPXPLS,
    waist = BMXWAIST,
    height = BMXHT
  )

# 4. Merge all datasets
nhanes_0910 <- nhanes_0910 %>%
  left_join(lab_0910, by = "SEQN") %>%
  left_join(exam_0910, by = "SEQN") %>%
  select(
    survey_years, SEQN,
    gender, age, race, race_w_nh_asian,
    CRP, A1C, HDL,
    PULSE, waist, height,
    WTINT, WTMEC, WTPH,
    SDMVSTRA, SDMVPSU
  )

glimpse(nhanes_0910)

```

---

### Load 2007-2008 NHANES Data

> ⚠️ **Note:** The more detailed race/ethnicity variable `RIDRETH3` (which includes a separate category for Non-Hispanic Asian participants) is *not* available for NHANES survey cycles from 1999 to 2009. During these years, only the original `RIDRETH1` variable was collected.

```{r}

#####################
# Load 2007-2008 NHANES Data
#####################

# 1. Download and clean demographics (+ include weights + design vars)
nhanes_0708 <- nhanes("DEMO_E") %>%
  transmute(
    SEQN,
    survey_years = "2007-2008",
    gender = RIAGENDR,
    age = RIDAGEYR,
    race = RIDRETH1,
    race_w_nh_asian = NA, # Placeholder for harmonization (RIDRETH3 not measured in this cycle)

    # weights (renamed for cross-cycle harmonization)
    WTINT = WTINT2YR, # Full sample 2 year interview weight
    WTMEC = WTMEC2YR, # Full sample 2 year MEC exam weight

    # design variables (needed for correct variance estimation)
    SDMVSTRA = SDMVSTRA, # Masked variance unit pseudo-stratum variable for variance estimation
    SDMVPSU  = SDMVPSU # Masked variance unit pseudo-PSU variable for variance estimation
  )

# 2. Download and clean lab data
# Note: No separate phlebotomy weight is provided for 2007–2008;
# lab variables should use the MEC exam weight (WTMEC).
lab_0708 <- list(
  nhanes("GHB_E"),
  nhanes("HDL_E"),
  nhanes("CRP_E")
) %>%
  reduce(left_join, by = "SEQN") %>%
  transmute(
    SEQN,
    CRP = LBXCRP,
    A1C = LBXGH,
    HDL = LBDHDD,

    WTPH = NA_real_ # Placeholder for harmonization (no phlebotomy weight for this cycle)
  )

# 3. Download and clean exam data
exam_0708 <- nhanes("BPX_E") %>%
  left_join(nhanes("BMX_E"), by = "SEQN") %>%
  transmute(
    SEQN,
    PULSE = BPXPLS,
    waist = BMXWAIST,
    height = BMXHT
  )

# 4. Merge all datasets
nhanes_0708 <- nhanes_0708 %>%
  left_join(lab_0708, by = "SEQN") %>%
  left_join(exam_0708, by = "SEQN") %>%
  select(
    survey_years, SEQN,
    gender, age, race, race_w_nh_asian,
    CRP, A1C, HDL,
    PULSE, waist, height,
    WTINT, WTMEC, WTPH,
    SDMVSTRA, SDMVPSU
  )

glimpse(nhanes_0708)

```

---

### Load 2005-2006 NHANES Data

> ⚠️ **Note:** The more detailed race/ethnicity variable `RIDRETH3` (which includes a separate category for Non-Hispanic Asian participants) is *not* available for NHANES survey cycles from 1999 to 2009. During these years, only the original `RIDRETH1` variable was collected.

```{r}

#####################
# Load 2005-2006 NHANES Data
#####################

# 1. Download and clean demographics (+ include weights + design vars)
nhanes_0506 <- nhanes("DEMO_D") %>%
  transmute(
    SEQN,
    survey_years = "2005-2006",
    gender = RIAGENDR,
    age = RIDAGEYR,
    race = RIDRETH1,
    race_w_nh_asian = NA, # Placeholder for harmonization (RIDRETH3 not measured in this cycle)

    # weights (renamed for cross-cycle harmonization)
    WTINT = WTINT2YR, # Full sample 2 year interview weight
    WTMEC = WTMEC2YR, # Full sample 2 year MEC exam weight

    # design variables (needed for correct variance estimation)
    SDMVSTRA = SDMVSTRA, # Masked variance unit pseudo-stratum variable for variance estimation
    SDMVPSU  = SDMVPSU # Masked variance unit pseudo-PSU variable for variance estimation
  )

# 2. Download and clean lab data
# Note: No separate phlebotomy weight is provided for 2005–2006;
# lab variables should use the MEC exam weight (WTMEC).
lab_0506 <- list(
  nhanes("GHB_D"),
  nhanes("HDL_D"),
  nhanes("CRP_D")
) %>%
  reduce(left_join, by = "SEQN") %>%
  transmute(
    SEQN,
    CRP = LBXCRP,
    A1C = LBXGH,
    HDL = LBDHDD,

    WTPH = NA_real_ # Placeholder for harmonization (no phlebotomy weight for this cycle)
  )

# 3. Download and clean exam data
exam_0506 <- nhanes("BPX_D") %>%
  left_join(nhanes("BMX_D"), by = "SEQN") %>%
  transmute(
    SEQN,
    PULSE = BPXPLS,
    waist = BMXWAIST,
    height = BMXHT
  )

# 4. Merge all datasets
nhanes_0506 <- nhanes_0506 %>%
  left_join(lab_0506, by = "SEQN") %>%
  left_join(exam_0506, by = "SEQN") %>%
  select(
    survey_years, SEQN,
    gender, age, race, race_w_nh_asian,
    CRP, A1C, HDL,
    PULSE, waist, height,
    WTINT, WTMEC, WTPH,
    SDMVSTRA, SDMVPSU
  )

glimpse(nhanes_0506)

```

---

### Load 2003-2004 NHANES Data

> ⚠️ **Note:** The more detailed race/ethnicity variable `RIDRETH3` (which includes a separate category for Non-Hispanic Asian participants) is *not* available for NHANES survey cycles from 1999 to 2009. During these years, only the original `RIDRETH1` variable was collected.

```{r}

#####################
# Load 2003-2004 NHANES Data
#####################

# 1. Download and clean demographics (+ include weights + design vars)
nhanes_0304 <- nhanes("DEMO_C") %>%
  transmute(
    SEQN,
    survey_years = "2003-2004",
    gender = RIAGENDR,
    age = RIDAGEYR,
    race = RIDRETH1,
    race_w_nh_asian = NA, # Placeholder for harmonization (RIDRETH3 not measured in this cycle)

    # weights (renamed for cross-cycle harmonization)
    WTINT = WTINT2YR, # Full sample 2 year interview weight
    WTMEC = WTMEC2YR, # Full sample 2 year MEC exam weight

    # design variables (needed for correct variance estimation)
    SDMVSTRA = SDMVSTRA, # Masked variance unit pseudo-stratum variable for variance estimation
    SDMVPSU  = SDMVPSU # Masked variance unit pseudo-PSU variable for variance estimation
  )

# 2. Download and clean lab data
# Note: No separate phlebotomy weight is provided for 2003–2004;
# lab variables should use the MEC exam weight (WTMEC).
lab_0304 <- list(
  nhanes("L10_C"),
  nhanes("L13_C"),
  nhanes("L11_C")
) %>%
  reduce(left_join, by = "SEQN") %>%
  transmute(
    SEQN,
    CRP = LBXCRP,
    A1C = LBXGH,
    HDL = LBXHDD,

    WTPH = NA_real_ # Placeholder for harmonization (no phlebotomy weight for this cycle)
  )

# 3. Download and clean exam data
exam_0304 <- nhanes("BPX_C") %>%
  left_join(nhanes("BMX_C"), by = "SEQN") %>%
  transmute(
    SEQN,
    PULSE = BPXPLS,
    waist = BMXWAIST,
    height = BMXHT
  )

# 4. Merge all datasets
nhanes_0304 <- nhanes_0304 %>%
  left_join(lab_0304, by = "SEQN") %>%
  left_join(exam_0304, by = "SEQN") %>%
  select(
    survey_years, SEQN,
    gender, age, race, race_w_nh_asian,
    CRP, A1C, HDL,
    PULSE, waist, height,
    WTINT, WTMEC, WTPH,
    SDMVSTRA, SDMVPSU
  )

glimpse(nhanes_0304)

```

---

### Load 2001-2002 NHANES Data

> ⚠️ **Note:** The more detailed race/ethnicity variable `RIDRETH3` (which includes a separate category for Non-Hispanic Asian participants) is *not* available for NHANES survey cycles from 1999 to 2009. During these years, only the original `RIDRETH1` variable was collected.

```{r}

#####################
# Load 2001-2002 NHANES Data
#####################

# 1. Download and clean demographics (+ include weights + design vars)
nhanes_0102 <- nhanes("DEMO_B") %>%
  transmute(
    SEQN,
    survey_years = "2001-2002",
    gender = RIAGENDR,
    age = RIDAGEYR,
    race = RIDRETH1,
    race_w_nh_asian = NA, # Placeholder for harmonization (RIDRETH3 not measured in this cycle)

    # weights (renamed for cross-cycle harmonization)
    WTINT = WTINT2YR, # Full sample 2 year interview weight
    WTMEC = WTMEC2YR, # Full sample 2 year MEC exam weight

    # design variables (needed for correct variance estimation)
    SDMVSTRA = SDMVSTRA, # Masked variance unit pseudo-stratum variable for variance estimation
    SDMVPSU  = SDMVPSU # Masked variance unit pseudo-PSU variable for variance estimation
  )

# 2. Download and clean lab data
# Note: No separate phlebotomy weight is provided for 2001–2002;
# lab variables should use the MEC exam weight (WTMEC).
lab_0102 <- list(
  nhanes("L10_B"),
  nhanes("L13_B"),
  nhanes("L11_B")
) %>%
  reduce(left_join, by = "SEQN") %>%
  transmute(
    SEQN,
    CRP = LBXCRP,
    A1C = LBXGH,
    HDL = LBDHDL,

    WTPH = NA_real_ # Placeholder for harmonization (no phlebotomy weight for this cycle)
  )

# 3. Download and clean exam data
exam_0102 <- nhanes("BPX_B") %>%
  left_join(nhanes("BMX_B"), by = "SEQN") %>%
  transmute(
    SEQN,
    PULSE = BPXPLS,
    waist = BMXWAIST,
    height = BMXHT
  )

# 4. Merge all datasets
nhanes_0102 <- nhanes_0102 %>%
  left_join(lab_0102, by = "SEQN") %>%
  left_join(exam_0102, by = "SEQN") %>%
  select(
    survey_years, SEQN,
    gender, age, race, race_w_nh_asian,
    CRP, A1C, HDL,
    PULSE, waist, height,
    WTINT, WTMEC, WTPH,
    SDMVSTRA, SDMVPSU
  )

glimpse(nhanes_0102)

```

---

### Load 1999-2000 NHANES Data

> ⚠️ **Note:** The more detailed race/ethnicity variable `RIDRETH3` (which includes a separate category for Non-Hispanic Asian participants) is *not* available for NHANES survey cycles from 1999 to 2009. During these years, only the original `RIDRETH1` variable was collected.

```{r}

#####################
# Load 1999-2000 NHANES Data
#####################

# 1. Download and clean demographics (+ include weights + design vars)
nhanes_9900 <- nhanes("DEMO") %>%
  transmute(
    SEQN,
    survey_years = "1999-2000",
    gender = RIAGENDR,
    age = RIDAGEYR,
    race = RIDRETH1,
    race_w_nh_asian = NA, # Placeholder for harmonization (RIDRETH3 not measured in this cycle)

    # weights (renamed for cross-cycle harmonization)
    WTINT = WTINT2YR, # Full sample 2 year interview weight
    WTMEC = WTMEC2YR, # Full sample 2 year MEC exam weight

    # design variables (needed for correct variance estimation)
    SDMVSTRA = SDMVSTRA, # Masked variance unit pseudo-stratum variable for variance estimation
    SDMVPSU  = SDMVPSU # Masked variance unit pseudo-PSU variable for variance estimation
  )

# 2. Download and clean lab data
# Note: No separate phlebotomy weight is provided for 1999–2000;
# lab variables should use the MEC exam weight (WTMEC).
lab_9900 <- list(
  nhanes("LAB10"),
  nhanes("LAB13"),
  nhanes("LAB11")
) %>%
  reduce(left_join, by = "SEQN") %>%
  transmute(
    SEQN,
    CRP = LBXCRP,
    A1C = LBXGH,
    HDL = LBDHDL,

    WTPH = NA_real_ # Placeholder for harmonization (no phlebotomy weight for this cycle)
  )

# 3. Download and clean exam data
exam_9900 <- nhanes("BPX") %>%
  left_join(nhanes("BMX"), by = "SEQN") %>%
  transmute(
    SEQN,
    PULSE = BPXPLS,
    waist = BMXWAIST,
    height = BMXHT
  )

# 4. Merge all datasets
nhanes_9900 <- nhanes_9900 %>%
  left_join(lab_9900, by = "SEQN") %>%
  left_join(exam_9900, by = "SEQN") %>%
  select(
    survey_years, SEQN,
    gender, age, race, race_w_nh_asian,
    CRP, A1C, HDL,
    PULSE, waist, height,
    WTINT, WTMEC, WTPH,
    SDMVSTRA, SDMVPSU
  )

glimpse(nhanes_9900)

```

---

### Combine 1999-2023 NHANES Data

```{r}

nhanes_merged <- NULL

nhanes_list <- list(nhanes_9900, 
                    nhanes_0102, 
                    nhanes_0304, 
                    nhanes_0506, 
                    nhanes_0708, 
                    nhanes_0910, 
                    nhanes_1112, 
                    nhanes_1314, 
                    nhanes_1516, 
                    nhanes_1718, 
                    nhanes_1720PP, 
                    nhanes_2123
)

# Merge all NHANES survey cycles
nhanes_merged <- bind_rows(nhanes_list) %>%
  mutate(
    race_w_nh_asian = as.factor(race_w_nh_asian) # Convert placeholder race column to factor
  )

# Preview the merged data
glimpse(nhanes_merged)
```

---


## Part 2 – Derive Biomarker Risk Indicators & Compute Allostatic Load

Now that we’ve combined multiple NHANES cycles into a single dataset, we’re ready to compute risk thresholds and calculate our main outcome: allostatic (over)load. This section includes:

- Computing Waist-to-Height Ratio (`WHtR`) from `waist` and `height`
- Creating `biomarker_count`, the number of non-missing biomarker values per observation (0–5)
- Computing cycle-specific weighted quartile thresholds for each biomarker (by `survey_years`)
- Creating risk indicators for `CRP`, `A1C`, `HDL`, `PULSE`, and `WHtR`
- Summing individual risk scores into a total Allostatic Load score (`al_score`, 0–5)

*Note:* This script uses NHANES sampling weights to compute weighted percentile thresholds. It does not perform weighted inferential analyses (e.g., standard errors or hypothesis tests). Users conducting population-level inference should incorporate survey design variables (`STRATUM`, `SECU`) alongside the appropriate weights.


```{r}
# Add new columns
nhanes_merged <- nhanes_merged %>%
  mutate(
    al_score = NA_real_, CRP_risk_threshold = NA_real_, CRP_risk_score = NA_real_,
    A1C_risk_threshold = NA_real_, A1C_risk_score = NA_real_,
    HDL_risk_threshold = NA_real_, HDL_risk_score = NA_real_,
    PULSE_risk_threshold = NA_real_, PULSE_risk_score = NA_real_, WHtR = NA_real_, WHtR_risk_threshold = NA_real_, WHtR_risk_score = NA_real_, biomarker_count = NA_real_
  ) %>%
  # Reorder columns
  select(
    SEQN, survey_years, al_score, age, race, race_w_nh_asian, gender,
    CRP, CRP_risk_threshold, CRP_risk_score,
    A1C, A1C_risk_threshold, A1C_risk_score,
    HDL, HDL_risk_threshold, HDL_risk_score,
    PULSE, PULSE_risk_threshold, PULSE_risk_score,
    waist, height, WHtR, WHtR_risk_threshold, WHtR_risk_score, biomarker_count,
    WTINT, WTMEC, WTPH, SDMVSTRA, SDMVPSU # weights, design variables
    )

# Preview with new columns added
glimpse(nhanes_merged)
```

---


### Calculate Weighted Quartile Risk Thresholds

Next, we’ll compute biomarker risk thresholds by survey cycle (`survey_years`). For `CRP`, `A1C`, `PULSE` and `WHtR`, the weighted 75th percentile (Q3) is used. For `HDL`, where lower values indicate higher risk, the weighted 25th percentile (Q1) is used. Thresholds are stored in `CRP_risk_threshold`, `A1C_risk_threshold`, `PULSE_risk_threshold`, `WHtR_Q3` and `HDL_risk_threshold`, respectively.


Helper function for weighted quantiles

```{r}

# Helper function for weighted quantiles:
# Returns NA if a survey cycle has no valid observations.
# Prevents errors in cycles where a biomarker was not measured (e.g., CRP in 2011–2014).
wtd_q_safe <- function(x, w, p) {
  ok <- !is.na(x) & !is.na(w) & w > 0
  if (sum(ok) == 0) return(NA_real_)
  as.numeric(Hmisc::wtd.quantile(x[ok], weights = w[ok], probs = p, na.rm = TRUE))
}

```


Calculate Quartile Risk Thresholds

```{r}

# Compute Waist-to-Height Ratio (`WHtR`) from `waist` and `height`
nhanes_merged <- nhanes_merged %>%
  mutate(WHtR = waist / height)

# Compute `biomarker_count` – number of non-missing biomarker values (0–5)
nhanes_merged <- nhanes_merged %>%
  mutate(
    biomarker_count = rowSums(!is.na(select(., CRP, A1C, HDL, PULSE, WHtR)))
  )

# Compute weighted quartile risk thresholds grouped by `survey_years`
quartile_thresholds <- nhanes_merged %>%
  mutate(
    w_lab = if_else(!is.na(WTPH), WTPH, WTMEC), # Use phlebotomy weight when available (2021-2023); otherwise use MEC exam weight
    w_exam = WTMEC, # Exam measures use MEC exam weight

    # safeguard: exclude missing/zero weights from weighted quantile calculations
    w_lab_q = if_else(!is.na(w_lab) & w_lab > 0, w_lab, NA_real_),
    w_exam_q = if_else(!is.na(w_exam) & w_exam > 0, w_exam, NA_real_)
  ) %>%
  group_by(survey_years) %>%
  summarise(
    CRP_risk_threshold   = wtd_q_safe(CRP,   w_lab_q,  0.75),
    A1C_risk_threshold   = wtd_q_safe(A1C,   w_lab_q,  0.75),
    HDL_risk_threshold   = wtd_q_safe(HDL,   w_lab_q,  0.25),
    PULSE_risk_threshold = wtd_q_safe(PULSE, w_exam_q, 0.75),
    WHtR_risk_threshold  = wtd_q_safe(WHtR,  w_exam_q, 0.75),
    .groups = "drop"
  )

# Populate threshold columns by survey cycle
nhanes_merged <- nhanes_merged %>%
  left_join(quartile_thresholds, by = "survey_years", suffix = c("", "_new")) %>%
  mutate(
    CRP_risk_threshold   = CRP_risk_threshold_new,
    A1C_risk_threshold   = A1C_risk_threshold_new,
    HDL_risk_threshold   = HDL_risk_threshold_new,
    PULSE_risk_threshold = PULSE_risk_threshold_new,
    WHtR_risk_threshold  = WHtR_risk_threshold_new
  ) %>%
  select(-ends_with("_new"))

glimpse(nhanes_merged)

```


### Calculate Risk Scores

Risk scores are assigned based on biomarker thresholds. For `CRP`, `A1C`, `PULSE` and `WHtR`, a score of 1 (high risk) is given if the value meets or exceeds the Q3 threshold; otherwise, the score is 0. For `HDL`, a score of 1 is given if the value is at or below the Q1 threshold. Scores are set to `NA` if the value or its threshold is missing.


```{r}
# Compute risk scores based on thresholds
nhanes_merged <- nhanes_merged %>%
  mutate(
    CRP_risk_score = ifelse(!is.na(CRP) & !is.na(CRP_risk_threshold) & CRP >= CRP_risk_threshold, 1, ifelse(!is.na(CRP), 0, NA)),
    A1C_risk_score = ifelse(!is.na(A1C) & !is.na(A1C_risk_threshold) & A1C >= A1C_risk_threshold, 1, ifelse(!is.na(A1C), 0, NA)),
    PULSE_risk_score = ifelse(!is.na(PULSE) & !is.na(PULSE_risk_threshold) & PULSE >= PULSE_risk_threshold, 1, ifelse(!is.na(PULSE), 0, NA)),
    HDL_risk_score = ifelse(!is.na(HDL) & !is.na(HDL_risk_threshold) & HDL <= HDL_risk_threshold, 1, ifelse(!is.na(HDL), 0, NA)),
    WHtR_risk_score = ifelse(!is.na(WHtR) & !is.na(WHtR_risk_threshold) & WHtR >= WHtR_risk_threshold, 1, ifelse(!is.na(WHtR), 0, NA))
    )

# Preview the updated dataset
glimpse(nhanes_merged)

```

---

### Calculate Allostatic (over)Load

Allostatic (over)load scores (`al_score`) are computed by summing individual risk indicators (`CRP_risk_score`, `A1C_risk_score`, `HDL_risk_score`, `PULSE_risk_score`, `WHtR_risk_score`). If any of these risk scores are missing (`NA`), the overall AL score is also set to `NA`.

```{r}
# Compute `al_score` by summing risk scores, leaving `NA` if any risk score is `NA`
nhanes_merged <- nhanes_merged %>%
  mutate(
    al_score = ifelse(
      rowSums(is.na(select(., CRP_risk_score, A1C_risk_score, PULSE_risk_score, WHtR_risk_score, HDL_risk_score))) > 0,
      NA_real_,  # Return NA if any risk score is NA for the row
      rowSums(select(., CRP_risk_score, A1C_risk_score, PULSE_risk_score, WHtR_risk_score, HDL_risk_score), na.rm = TRUE)
    )
  )

# Preview the updated dataset
glimpse(nhanes_merged)

```

---

### Save and Export Prepared NHANES Data

Export the final cleaned dataset in your preferred format. Below are examples using both `.csv` and `.rds` formats. 

```{r}

# write.csv(nhanes_merged, "name_your_nhanes_dataset.csv")
# Example: write.csv(nhanes_merged, "nhanes_allostatic_load_data.csv", row.names = FALSE)

# saveRDS(nhanes_merged, "name_your_nhanes_dataset.rds")
# Example: saveRDS(nhanes_merged, "nhanes_allostatic_load_data.rds")


```


---

### Using NHANES Weights in Analysis

This dataset includes NHANES sampling weights (`WTINT`, `WTMEC`, `WTPH`) and survey design variables (`SDMVSTRA`, `SDMVPSU`) to support analyses that account for the complex survey design.  

A few general guidelines:  

- Use sample weights when estimating population statistics (means, proportions, percentiles, regression models, etc.) intended to represent the U.S. population.  
- Use both weights and design variables when calculating standard errors, confidence intervals, or conducting hypothesis tests. These analyses typically use survey-design methods (for example, the survey package in R).  
- Different variables require different weights:  

  - Demographic variables → `WTINT`
  - Examination variables → `WTMEC`
  - Laboratory variables → `WTPH` (when available, otherwise use `WTMEC`)

This script uses weights to compute biomarker risk thresholds but does not perform weighted inference; users conducting inferential or population-level analyses should apply survey weights and design variables appropriately.  

For detailed guidance, see the [CDC NHANES tutorial](https://wwwn.cdc.gov/nchs/nhanes/tutorials/weighting.aspx):  
https://wwwn.cdc.gov/nchs/nhanes/tutorials/weighting.aspx  
